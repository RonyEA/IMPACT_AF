---
title: "Introduction to IMPACTaf"
author: "Dr. Chris Kypridemos"
date: "11 March, 2024"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{How to run scenarios in IMPACTaf}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

#### Structer of Model
#TODO: Describe the structure of the model


#### List for primary prevention variables 

- **smok_status_curr_xps** : this is current smoking status; 1 = never smoker, 2 = occasional smoker, 3 = ex-smoker, 4 = current smoker
- **smok_cig_curr_xps** : Cigarettes per day     
- **alcohol_curr_xps** : alcohol consumption in g/day     
- **bmi_curr_xps** : Body mass index in kg/m\^2 (BMI)       


#### List for secondary prevention variables 

- **af** : Atrial fibrillation 


#### How to initialize the model


```{r}
library(IMPACTaf)

IMPACTncd <- Simulation$new("./inputs/sim_design.yaml")
```

The above line of code initializes the Simulation object, which takes in a the path to a "sim_design.yaml" file. This file contains the simulation parameters. 
#TODO: should we describe all the parameters in the sim_design file?


In this vignette, we will run three example scenarios to demonstrate the sorts of alternative scenarios that can be run in IMPACTncdEngl:

- Reducing BMI by 10% in all simulants compared to their BMI in the baseline scenario


For our alternative scenarios, we will set the first year the change starts to 2023. We run the baseline scenario before the alternative scenarios so that we can compare results. The results from each additional scenario get appended to the baseline scenario.


In particular, you may need to adjust the `n` and `n_synthpop_aggregation` parameters to create the desired synthetic population size. If you use the same `synthpop_dir` location as in your test run, the new synthpop files will have a different filename and will not overwrite the existing files. However, you may want to delete the existing synthpop files in the folder to save disk space.

1.  To run a baseline scenario, run the following chunk of code, which deletes everything inside the existing output and log folders, runs a new baseline scenario from scratch and summarises the results of the simulation. 

```{r, run-simulation, eval = FALSE}
IMPACTncd$
  del_logs()$
  del_outputs()$
  run(mc = 1:2, multicore = FALSE, scenario_nam = "sc0")$
  export_summaries(multicore = FALSE)
```

In the above, we use the chain syntax using $, which is equivalent to: 

```{r, run-simulation-break, eval = FALSE}
IMPACTncd$del_logs()
IMPACTncd$del_outputs()
IMPACTncd$run(mc = 1:2, multicore = FALSE, scenario_nam = "sc0")
IMPACTncd$export_summaries(multicore = FALSE)
```

Note: In the arguments for the `run()`, we have selected the number of Monte Carlo iterations to be 2  (mc = 1:2). This is OK for a test run, but in reality, you would like to run at least 100 iterations (i.e. mc = 1:100) in production. If, at a later point, you would like to run 100 more iterations additionally, then you could do `IMPACTncd$run(mc = 101:200, multicore = FALSE, scenario_nam = "sc0")` without deleting the existing output (i.e. do not run `IMPACTncd$del_outputs()`). 

We have also selected `multicore = FALSE` here so that parallel processing is not used. This slows down the simulation, but it requires substantially less computational resources. In production, you would most likely want to set this to TRUE. The third argument of the `run()` function defines the name of the baseline scenario as "sc0" here. Please do not change the name of the baseline scenario.

Finally, the `export_summaries()` generates summary output files from the lifecourse files that are the raw simulation output.

2. After running the code, we will create the folders shown below. The `lifecourse` folder has the same number of files as the number of iterations runs. 

```{r, echo = FALSE, out.width = "50%", fig.cap = "output/hf_real folder structure"}
knitr::include_graphics("img/output_folder.jpg")
```

3. After running the baseline scenario, we can run alternative scenarios by updating some of the parameters in `primary_prevention_scn`. 

In this example, we will simulate a scenario in which the BMI of all simulants is 10% lower than in the baseline scenario, we will start this change in the year 2023, and we will run two iterations (the same as in the baseline scenario above). In this `n_runs` as the number of iterations. 

```{r, n-run, eval = FALSE}
n_runs <- 2
```

4. After defining the parameters we need to update `primary_prevention_scn` before running each alternative scenario. We will start by reducing BMI by 10% for all simulants, for every year from 2023 onwards. In this `change_10pc` is the % of change we want to implement in all the scenarios, `sc_year` as the year from which the change should be implemented.

```{r, scn1, eval = FALSE}
IMPACTncd$update_primary_prevention_scn(
  function(sp) {
    change_10pc <- 0.1
    sc_year <- 23L
    sp$pop[year >= sc_year,
           bmi_curr_xps := bmi_curr_xps * (1 -change_10pc)]
    }
  )
```

5. Once the `primary_prevention_scn` is updated we need to run the simulation again as shown below, in this we use the simulation name as `sc1` to represent the scenario we defined above. 

Again, as we will run more scenarios, we donâ€™t need to export the summaries. 

The results from running this scenario will be appended to the baseline scenario results in the lifecourse folder. 

```{r, run-scn1, eval = FALSE}
IMPACTncd$
  run(1:n_runs, multicore = FALSE, "sc1")
```


We will use `export_summaries` to export summary files into the summaries folder in our output directory. 


In this example, we specify the `type` to only export a few of the summary outputs to reduce computation time. We have chosen: 

- **dis_char** : disease characteristics, e.g. age of onset of condition, mean duration of condition; 
- **prvl** : prevalence of each condition; 
- **incd** : incidence of each condition; 
- **dis_mrtl** : disease-specific mortality; 
- **mrtl** : all-cause mortality; 
- **allcause_mrtl_by_dis** : all-cause mortality by disease;


If type is not specified, all summary files are exported. 

```{r, run-sc4, eval = FALSE}
IMPACTncd$
  run(1:n_runs, multicore = FALSE, "sc4") $
    export_summaries(multicore = FALSE, type = c("dis_char", "prvl",
                     "incd", "dis_mrtl", "mrtl",
                     "allcause_mrtl_by_dis", "cms"))
```